<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador Fiscal - Proyecto Omar</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.28.5/docxtemplater.js"></script>
    <script src="https://unpkg.com/pizzip@3.1.1/dist/pizzip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
    
    <style>
        body { max-width: 800px; margin: auto; padding: 20px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .caja-opcional {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            border: 1px dashed #ccc;
            margin: 15px 0;
            display: none; /* Oculto por defecto */
        }
        .visible { display: block !important; }
        .caja-firma { background-color: #f0f4f8; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .check-group { display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: bold; }
        input[type="checkbox"] { width: 20px; height: 20px; margin: 0; }
    </style>
</head>
<body>

    <h1>‚öñÔ∏è CEE LIBERTAD - PROYECTO OMAR</h1>
    <hr>

    <form id="docForm">
        <div class="grid">
            <div>
                <label>N¬∞ Disposici√≥n</label>
                <input type="text" id="num_disp" value="01-2026">
                
                <label>DNI Imputado</label>
                <input type="text" id="dni" maxlength="8">
                
                <label>Nombre Completo</label>
                <input type="text" id="nombre">
            </div>
            <div>
                <label>Fecha de Hoy</label>
                <input type="text" id="fecha_disp">
                
                <label>Fecha de los Hechos</label>
                <input type="text" id="fecha_hechos" placeholder="Ej: 23 de febrero de 2026">
            </div>
        </div>

        <div class="caja-firma">
            <label class="check-group">
                <input type="checkbox" id="check_vehiculo" onchange="toggleVehiculo()">
                ¬øHABR√Å DEVOLUCI√ìN DE VEH√çCULO?
            </label>
        </div>

        <div id="seccion_vehiculo_campos" class="caja-opcional">
            <div class="grid">
                <label>Veh√≠culo (Marca/Modelo) <input type="text" id="vehiculo" placeholder="Ej: Camioneta Toyota"></label>
                <label>N¬∞ Placa <input type="text" id="placa" placeholder="Ej: P1A-999"></label>
            </div>
        </div>

        <label>Hechos Indagados</label>
        <textarea id="hechos" rows="3"></textarea>

        <div class="grid">
            <label>N¬∞ Certificado Dosaje <input type="text" id="num_dosaje"></label>
            <label>Resultado (N√∫mero) <input type="number" step="0.01" id="res_dosaje" value="0.47"></label>
        </div>

        <div class="caja-firma">
            <label class="check-group">
                <input type="checkbox" id="check_firma">
                ¬øCONSIGNAR FIRMA EN EL DOCUMENTO?
            </label>
        </div>

        <button type="button" onclick="generarDocumento()">üöÄ DESCARGAR DISPOSICI√ìN</button>
    </form>

    <script>
        // Funci√≥n para mostrar/ocultar campos de veh√≠culo
        function toggleVehiculo() {
            const seccion = document.getElementById('seccion_vehiculo_campos');
            seccion.classList.toggle('visible', document.getElementById('check_vehiculo').checked);
        }

        window.onload = function() {
            const meses = ["enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"];
            const f = new Date();
            document.getElementById('fecha_disp').value = `Piura, ${f.getDate()} de ${meses[f.getMonth()]} de ${f.getFullYear()}`;
        };

        function convertirDosajeALetras(num) {
            const valor = parseFloat(num);
            if (isNaN(valor)) return "";
            const partes = valor.toFixed(2).split('.');
            const unidades = ["cero", "un", "dos", "tres", "cuatro", "cinco", "seis", "siete", "ocho", "nueve"];
            return `${unidades[parseInt(partes[0])] || partes[0]} gramos con ${partes[1]} centigramos de alcohol por litro de sangre`;
        }

        async function generarDocumento() {
            const conFirma = document.getElementById('check_firma').checked;
            const conVehiculo = document.getElementById('check_vehiculo').checked;
            const archivoModelo = conFirma ? 'MODELO_3_FIRMADO.docx' : 'MODELO_3.docx';

            const data = {
                NUMERO_DISPOSICION: document.getElementById('num_disp').value,
                FECHA_DISPOSICION: document.getElementById('fecha_disp').value,
                NOMBRE_IMPUTADO: document.getElementById('nombre').value.toUpperCase(),
                NUMERO_DNI: document.getElementById('dni').value,
                FECHA_DE_HECHOS: document.getElementById('fecha_hechos').value,
                HECHOS: document.getElementById('hechos').value,
                NUMER_DOSAJE: document.getElementById('num_dosaje').value,
                RESULTADO_DOSAJE: document.getElementById('res_dosaje').value + " G/L",
                RESULTADO_DOSAJE_LETRAS: convertirDosajeALetras(document.getElementById('res_dosaje').value),
                
                // L√≥gica condicional para el Word
                mostrar_vehiculo: conVehiculo, 
                VEHICULO: document.getElementById('vehiculo').value.toUpperCase(),
                PLACA: document.getElementById('placa').value.toUpperCase()
            };

            try {
                const response = await fetch(archivoModelo);
                const content = await response.arrayBuffer();
                const zip = new PizZip(content);
                const doc = new window.docxtemplater(zip, { paragraphLoop: true, linebreaks: true });

                doc.render(data);

                const out = doc.getZip().generate({
                    type: "blob",
                    mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                });

                saveAs(out, `Disposicion_${data.NUMERO_DNI}.docx`);
            } catch (error) {
                alert("Error al cargar los modelos .docx");
            }
        }
    </script>
</body>
</html>
